# Lesson 5: Batch and Stream Processing (Docker)

Source of learning: https://developer.confluent.io/courses/apache-flink/stream-processing-exercise/

> Disclaimer:  
> Note that all of the blockquote are the direct quoted from the source site.

## Prerequsite

- docker is installed and running
- have completed [lesson 4 - docker setup for kafka and flink](../lesson-4-docker-setup-for-kafka-flink/)

## Setup your environment

Check out [learn-apache-flink-docker](../learn-apache-flink-docker/) and:

- fulfilled prerequisites
- completed "Setup environment"

## Experiment with batch and streaming

Run command below to create a bounded table generated by faker table source with flink-faker.

```sql
CREATE TABLE `bounded_pageviews` (
  `url` STRING,
  `ts` TIMESTAMP(3)
)
WITH (
  'connector' = 'faker',
  'number-of-rows' = '500',
  'rows-per-second' = '100',
  'fields.url.expression' = '/#{GreekPhilosopher.name}.html',
  'fields.ts.expression' =  '#{date.past ''5'',''1'',''SECONDS''}'
);
```

Run command below to see how the table looks like.

```sql
SELECT * FROM bounded_pageviews LIMIT 10;
```

## Batch mode, bounded input

> By default, the Flink SQL Client is running in streaming mode.

Switch Flink SQL Client to batch mode.

```sql
SET 'execution.runtime-mode' = 'batch';
```

Run command below to see the updating table result

```sql
SELECT COUNT(*) AS `count` FROM bounded_pageviews;
```

You will see that it takes 5 seconds to complete, and then shown the final value.

## Streaming mode, bounded input

We will the same thing in streaming mode.

Switch Flink SQL Client to stream mode

```sql
SET 'execution.runtime-mode' = 'streaming';
```

Query the aggregated result.

```sql
SELECT COUNT(*) AS `count` FROM bounded_pageviews;
```

> You will see the count increment from 100 to 200, etc, up to 500. Again, this will take 5 seconds

To explore further, run command below to change the results display mode to changelog mode.

```sql
SET 'sql-client.execution.result-mode' = 'changelog';
```

Run the same query again to see the different result.

```sql
SELECT COUNT(*) AS `count` FROM bounded_pageviews;
```

## Streaming mode, unbounded input

Create a new unbounded table with command below

```sql
CREATE TABLE `streaming_pageviews` (
  `url` STRING,
  `ts` TIMESTAMP(3)
)
WITH (
  'connector' = 'faker',
  'rows-per-second' = '100',
  'fields.url.expression' = '/#{GreekPhilosopher.name}.html',
  'fields.ts.expression' =  '#{date.past ''5'',''1'',''SECONDS''}'
);
```

Reset the SQL client to default mode.

```sql
SET 'sql-client.execution.result-mode' = 'table';
```

Run command with the new table

```sql
SELECT COUNT(*) AS `count` FROM streaming_pageviews;
```

To alter the running speed, run command
```sql
ALTER TABLE `streaming_pageviews` SET ('rows-per-second' = '10');
```

**Congratulations!** You have completed this tutorial!
